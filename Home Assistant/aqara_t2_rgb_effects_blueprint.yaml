## Aqara T2 LED Bulb - RGB Dynamic Effects
## Home Assistant script blueprint
##
## Install to blueprints/script/aqara/aqara_t2_rgb_effects_blueprint.yaml

blueprint:
  name: Aqara T2 - RGB Dynamic Effect Script
  description: >
    Script blueprint to send dynamic RGB effect payloads to Aqara T2 LED bulbs via
    Zigbee2MQTT, using up to 8 RGB color pickers. Supports multiple lights.
    Effect brightness is controlled by the light's global brightness setting.
  domain: script
  source_url: https://github.com/absent42/Aqara-T2-bulb/blob/main/Home%20Assistant/aqara_t2_rgb_effects_blueprint.yaml
  input:
    target_lights:
      name: Target Lights
      description: >
        Select one or more T2 LED bulb entities or devices.
      selector:
        target:
          entity:
            - domain: light

    z2m_base_topic:
      name: Zigbee2MQTT Base Topic
      description: The base MQTT topic for your Zigbee2MQTT instance
      default: "zigbee2mqtt"
      selector:
        text:

    effect:
      name: Effect
      description: Select the dynamic effect to use
      default: "breathing"
      selector:
        select:
          options:
            - "off"
            - "breathing"
            - "candlelight"
            - "fading"
            - "flash"

    number_of_colors:
      name: Number of colors
      description: How many of the color pickers to use (1-8)
      default: 3
      selector:
        number:
          min: 1
          max: 8
          mode: slider

    color_01:
      name: Color 1
      description: First effect color
      default: [255, 0, 0]
      selector:
        color_rgb:

    color_02:
      name: Color 2
      description: Second effect color
      default: [255, 127, 0]
      selector:
        color_rgb:

    color_03:
      name: Color 3
      description: Third effect color
      default: [255, 255, 0]
      selector:
        color_rgb:

    color_04:
      name: Color 4
      description: Fourth effect color
      default: [0, 255, 0]
      selector:
        color_rgb:

    color_05:
      name: Color 5
      description: Fifth effect color
      default: [0, 255, 127]
      selector:
        color_rgb:

    color_06:
      name: Color 6
      description: Sixth effect color
      default: [0, 255, 255]
      selector:
        color_rgb:

    color_07:
      name: Color 7
      description: Seventh effect color
      default: [0, 127, 255]
      selector:
        color_rgb:

    color_08:
      name: Color 8
      description: Eighth effect color
      default: [0, 0, 255]
      selector:
        color_rgb:

    effect_speed:
      name: Effect Speed
      description: Speed of the RGB dynamic effect (1-100%)
      default: 50
      selector:
        number:
          min: 1
          max: 100
          unit_of_measurement: "%"
          mode: slider

sequence:
  - variables:
      z2m_base_topic: !input z2m_base_topic
      target_lights: !input target_lights
      effect: !input effect
      number_of_colors: !input number_of_colors
      effect_speed: !input effect_speed
      color_01: !input color_01
      color_02: !input color_02
      color_03: !input color_03
      color_04: !input color_04
      color_05: !input color_05
      color_06: !input color_06
      color_07: !input color_07
      color_08: !input color_08
  
  - variables:
      # Build array of all color choices
      all_colors: >
        {{ [color_01, color_02, color_03, color_04, color_05, color_06, color_07, color_08] }}
      
      # Build array of RGB objects based on number_of_colors
      color_array: >
        {% set ns = namespace(colors=[]) %}
        {% for i in range(number_of_colors | int) %}
          {% set color = all_colors[i] %}
          {% set ns.colors = ns.colors + [{"r": color[0], "g": color[1], "b": color[2]}] %}
        {% endfor %}
        {{ ns.colors | to_json }}
  
  - repeat:
      for_each: >
        {% set ns = namespace(lights=[]) %}
        {% if target_lights.entity_id is defined %}
          {% if target_lights.entity_id is string %}
            {% set ns.lights = [target_lights.entity_id] %}
          {% else %}
            {% set ns.lights = target_lights.entity_id %}
          {% endif %}
        {% endif %}
        {% if target_lights.device_id is defined %}
          {% if target_lights.device_id is string %}
            {% set device_entities = device_entities(target_lights.device_id) | select('match', '^light\.') | list %}
            {% set ns.lights = ns.lights + device_entities %}
          {% else %}
            {% for device_id in target_lights.device_id %}
              {% set device_entities = device_entities(device_id) | select('match', '^light\.') | list %}
              {% set ns.lights = ns.lights + device_entities %}
            {% endfor %}
          {% endif %}
        {% endif %}
        {% if target_lights.area_id is defined %}
          {% if target_lights.area_id is string %}
            {% set area_entities = area_entities(target_lights.area_id) | select('match', '^light\.') | list %}
            {% set ns.lights = ns.lights + area_entities %}
          {% else %}
            {% for area_id in target_lights.area_id %}
              {% set area_entities = area_entities(area_id) | select('match', '^light\.') | list %}
              {% set ns.lights = ns.lights + area_entities %}
            {% endfor %}
          {% endif %}
        {% endif %}
        {{ ns.lights | unique | list }}
      sequence:
        - variables:
            entity_device_id: "{{ device_id(repeat.item) }}"
            z2m_device_name: "{{ device_attr(entity_device_id, 'name') }}"
        
        - alias: "Set T2 RGB effect"
          service: mqtt.publish
          data:
            topic: "{{ z2m_base_topic }}/{{ z2m_device_name }}/set"
            payload: '{"effect":"{{ effect }}","effect_speed":{{ effect_speed }},"effect_colors":{{ color_array }}}'

mode: single
